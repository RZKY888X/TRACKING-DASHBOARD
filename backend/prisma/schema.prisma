generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vehicle {
  id          Int          @id @default(autoincrement())
  name        String
  driver      String?
  route       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  assignments Assignment[]
  positions   Position[]
  statuses    Status[]
}

model Driver {
  id   Int    @id @default(autoincrement())
  name String @unique
}

model Route {
  id              Int          @id @default(autoincrement())
  name            String       @unique
  origin          String?
  departure       String?
  fromAssignments Assignment[] @relation("FromRoute")
  toAssignments   Assignment[] @relation("ToRoute")
}

model Origin {
  id              Int          @id @default(autoincrement())
  destination     String       @unique
  fromAssignments Assignment[] @relation("FromOrigin")
}

model Departure {
  id            Int          @id @default(autoincrement())
  destination   String       @unique
  toAssignments Assignment[] @relation("ToDeparture")
}

model Position {
  id        Int      @id @default(autoincrement())
  vehicleId Int
  latitude  Float
  longitude Float
  speed     Float?
  timestamp DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model Status {
  id        Int      @id @default(autoincrement())
  vehicleId Int
  isOnline  Boolean  @default(true)
  battery   Int?
  timestamp DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  password     String
  name         String
  role         Role          @default(VIEWER)
  lastLoginAt  DateTime?
  lastLoginIp  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  profileImage String?
  jobRole      String?
  activities   ActivityLog[]
  assignments  Assignment[]
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entity      String?
  entityId    String?
  description String
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

/// *
///  * ===========================================
///  * ASSIGNMENT SYSTEM (NEW)
///  * ===========================================
model Assignment {
  id            Int        @id @default(autoincrement())
  userId        String
  vehicleId     Int
  fromId        Int?
  toId          Int?
  jobRole       String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  fromOriginId  Int?
  toDepartureId Int?
  fromRoute     Route?     @relation("FromRoute", fields: [fromId], references: [id])
  fromOrigin    Origin?    @relation("FromOrigin", fields: [fromOriginId], references: [id])
  toDeparture   Departure? @relation("ToDeparture", fields: [toDepartureId], references: [id])
  toRoute       Route?     @relation("ToRoute", fields: [toId], references: [id])
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle       Vehicle    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([vehicleId])
  @@index([fromId])
  @@index([toId])
  @@index([fromOriginId])
  @@index([toDepartureId])
}

enum Role {
  VIEWER
  USER
  ADMIN
  SUPERADMIN
}
