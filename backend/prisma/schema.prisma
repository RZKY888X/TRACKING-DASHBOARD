generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUM
//////////////////////////////////////////////////

enum Role {
  VIEWER
  USER
  ADMIN
  SUPERADMIN
}

enum TripStatus {
  ON_TRIP
  COMPLETED
}

enum AssignmentStatus {
  PENDING
  STARTED
  CANCELLED
}

//////////////////////////////////////////////////
// USER & LOG
//////////////////////////////////////////////////

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String
  name         String
  role         Role      @default(VIEWER)
  lastLoginAt  DateTime?
  lastLoginIp  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  profileImage String?
  jobRole      String?

  activities ActivityLog[]
  trips      Trip[]
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entity      String?
  entityId    String?
  description String
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

//////////////////////////////////////////////////
// MASTER DATA
//////////////////////////////////////////////////

model Driver {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())

  assignments Assignment[]
  trips       Trip[]
}

model Vehicle {
  id        Int      @id @default(autoincrement())
  plate     String   @unique
  type      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments Assignment[]
  trips       Trip[]
  positions   Position[]
  statuses    VehicleStatus[]
}

model Warehouse {
  id        Int    @id @default(autoincrement())
  name      String @unique
  city      String
  latitude  Float
  longitude Float

  originAssignments      Assignment[] @relation("AssignmentOrigin")
  destinationAssignments Assignment[] @relation("AssignmentDestination")

  originTrips      Trip[] @relation("OriginWarehouse")
  destinationTrips Trip[] @relation("DestinationWarehouse")
}

//////////////////////////////////////////////////
// ASSIGNMENT (REAL CASE CORE)
//////////////////////////////////////////////////

model Assignment {
  id            Int @id @default(autoincrement())
  driverId      Int
  vehicleId     Int
  originId      Int
  destinationId Int

  status    AssignmentStatus @default(PENDING)
  createdAt DateTime         @default(now())
  startedAt DateTime?

  driver      Driver    @relation(fields: [driverId], references: [id])
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id])
  origin      Warehouse @relation("AssignmentOrigin", fields: [originId], references: [id])
  destination Warehouse @relation("AssignmentDestination", fields: [destinationId], references: [id])

  trip Trip?
}

//////////////////////////////////////////////////
// TRIP (RUNTIME)
//////////////////////////////////////////////////

model Trip {
  id Int @id @default(autoincrement())

  assignmentId Int     @unique
  driverId     Int
  vehicleId    Int
  userId       String?

  originId      Int
  destinationId Int

  status    TripStatus @default(ON_TRIP)
  startTime DateTime   @default(now())
  endTime   DateTime?
  avgSpeed  Float?

  assignment Assignment @relation(fields: [assignmentId], references: [id])
  driver     Driver     @relation(fields: [driverId], references: [id])
  vehicle    Vehicle    @relation(fields: [vehicleId], references: [id])
  user       User?      @relation(fields: [userId], references: [id])

  origin      Warehouse @relation("OriginWarehouse", fields: [originId], references: [id])
  destination Warehouse @relation("DestinationWarehouse", fields: [destinationId], references: [id])

  positions Position[]

  @@index([status])
  @@index([startTime])
}

//////////////////////////////////////////////////
// GPS & STATUS
//////////////////////////////////////////////////

model Position {
  id        Int @id @default(autoincrement())
  tripId    Int
  vehicleId Int

  latitude  Float
  longitude Float
  speed     Float?
  timestamp DateTime @default(now())

  trip    Trip    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([timestamp])
}

model VehicleStatus {
  id        Int      @id @default(autoincrement())
  vehicleId Int
  isOnline  Boolean  @default(true)
  battery   Int?
  timestamp DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}
