generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ===========================================
   VEHICLE & ROUTING MODELS
=========================================== */

model Vehicle {
  id          Int          @id @default(autoincrement())
  name        String
  driver      String?
  route       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  positions   Position[]
  statuses    Status[]
  assignments Assignment[]
}

model Driver {
  id   Int    @id @default(autoincrement())
  name String @unique
}

model Route {
  id              Int          @id @default(autoincrement())
  name            String       @unique
  origin          String?
  departure       String?      // sekarang tujuan, bukan datetime

  fromAssignments Assignment[] @relation("FromRoute")
  toAssignments   Assignment[] @relation("ToRoute")
}


model Position {
  id        Int      @id @default(autoincrement())
  vehicleId Int
  latitude  Float
  longitude Float
  speed     Float?
  timestamp DateTime @default(now())

  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model Status {
  id        Int      @id @default(autoincrement())
  vehicleId Int
  isOnline  Boolean  @default(true)
  battery   Int?
  timestamp DateTime @default(now())

  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

/* ===========================================
   USER & AUTHENTICATION
=========================================== */

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password      String
  name          String
  role          Role          @default(VIEWER)
  lastLoginAt   DateTime?
  lastLoginIp   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  profileImage  String?
  jobRole       String?

  activities    ActivityLog[]
  assignments   Assignment[]
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entity      String?
  entityId    String?
  description String
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

/* ===========================================
   ASSIGNMENT SYSTEM (NEW)
=========================================== */

model Assignment {
  id        Int      @id @default(autoincrement())
  userId    String
  vehicleId Int
  fromId    Int
  toId      Int
  jobRole   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  fromRoute Route    @relation("FromRoute", fields: [fromId], references: [id])
  toRoute   Route    @relation("ToRoute", fields: [toId], references: [id])

  @@index([userId])
  @@index([vehicleId])
  @@index([fromId])
  @@index([toId])
}

/* ===========================================
   ROLES ENUM
=========================================== */

enum Role {
  VIEWER
  USER
  ADMIN
  SUPERADMIN
}
